api_version: 1.0

id: boostsecurityio/semgrep
name: Semgrep
namespace: boostsecurityio/semgrep
scan_types:
  - sast

config:
  support_diff_scan: true
  include_files:
  - .semgrep/*

setup:
  - name: Validate rules
    environment:
      SEMGREP_RULES: ${SEMGREP_RULES:-https://assets.build.boostsecurity.io/semgrep-rules/stable/all-sast-rules.yml}
    run: |
      echo "SEMGREP_RULES set to: '$SEMGREP_RULES'"
      for rule in $SEMGREP_RULES; do
        case "$rule" in
          .semgrep/*|http://*|https://*)
            # valid rule token; do nothing
            ;;
          *)
            echo "Semgrep Community Rules cannot be used. Provide a URL or relative path to rules file or leave blank for Boost curated rules."
            exit 1
            ;;
        esac
      done

steps:
  - scan:
      command:
        environment:
          NO_COLOR: "true"
          TRIVY_ADDITIONAL_ARGS: ${TRIVY_ADDITIONAL_ARGS---ignore-unfixed}
          TRIVY_DB_REPOSITORY: public.ecr.aws/aquasecurity/trivy-db:2,ghcr.io/aquasecurity/trivy-db:2
          TRIVY_JAVA_DB_REPOSITORY: public.ecr.aws/aquasecurity/trivy-java-db:1,ghcr.io/aquasecurity/trivy-java-db:1
        run: |
          dotnet new sln -n temp
          find . -name "*.csproj" -exec dotnet sln temp.sln add {} \;
          dotnet tool install CycloneDX --tool-path ./.dotnet-tools
          ./.dotnet-tools/dotnet-CycloneDX $(pwd)/temp.sln --output temp_sbom.json --output-format json
          cat temp_sbom.json/bom.json
