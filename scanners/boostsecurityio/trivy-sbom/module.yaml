api_version: 1.0

id: boostsecurityio/trivy-sbom
name: Trivy (FS SBOM)
namespace: boostsecurityio/trivy-sbom
scan_types:
  - sbom

config:
  support_diff_scan: false

setup:
  - name: Verify dotnet installed
    run: |
      mkdir -p $SETUP_PATH/scan-tools
      if ! dotnet --version ; then
        echo "dotnet is not installed, the scanner cannot run."
        exit 1
      fi
      dotnet tool install CycloneDX --version 5.5.0 --tool-path $SETUP_PATH/scan-tools/.dotnet-tools
      if [ $? -ne 0 ]; then
        echo "Failed to install CycloneDX"
        exit 1
      fi
      if ! "$SETUP_PATH/scan-tools/.dotnet-tools/dotnet-CycloneDX" --version >/dev/null 2>&1; then
        echo "CycloneDX did not install or run correctly"
        exit 1
      fi
      if [ ! -f "Directory.Packages.props" ]; then
        echo "No Directory.Packages.props found â€” creating placeholder"
        cat > Directory.Packages.props <<'EOF'
      <Project>
        <ItemGroup></ItemGroup>
      </Project>
      EOF
      fi

steps:
  - scan:
      command:
        run: |
          if [ ! -f "Directory.Packages.props" ]; then
            cat > Directory.Packages.props <<'EOF'
          <Project>
            <ItemGroup></ItemGroup>
          </Project>
          EOF
            RESTORE_FLAG="--disable-package-restore"
          else
            RESTORE_FLAG=""
          fi
          dotnet new sln -n temp > /dev/null 2>&1
          find . -name "*.csproj" -print0 | xargs -0 dotnet sln temp.sln add > /dev/null 2>&1
          $SETUP_PATH/scan-tools/.dotnet-tools/dotnet-CycloneDX $(pwd)/temp.sln $RESTORE_FLAG --output temp_sbom.json --output-format json > /dev/null 2>&1
          cat temp_sbom.json/bom.json
      format: cyclonedx

